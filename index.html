<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quem limpa a sala hoje?</title>
<style>
  /* Reset básico e centralização */
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: Arial, sans-serif;
    background: #f0f3f4;
    display: flex; justify-content: center; align-items: center;
    flex-direction: column;
    color: #2c3e50;
  }
  h1 {
    margin-bottom: 10px;
  }
  button, input[type="submit"] {
    padding: 10px 20px;
    font-size: 16px;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    background-color: #2c3e50;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover, input[type="submit"]:hover {
    background-color: #34495e;
  }
  /* Layout geral */
  #telaInicial {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
  }
  #telaInicial button {
    width: 220px;
  }
  #loginForm {
    display: none;
    flex-direction: column;
    gap: 10px;
    width: 300px;
  }
  #loginForm input {
    padding: 8px;
    font-size: 14px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  #app, #viewEstudante {
    display: none;
    max-width: 480px;
    width: 100%;
    background: white;
    padding: 20px 30px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
    position: relative;
  }
  #btnGerar {
    margin-bottom: 20px;
  }
  #resultado ul {
    list-style: none;
    padding: 0;
  }
  #resultado li {
    background: #ecf0f1;
    margin-bottom: 10px;
    padding: 12px;
    border-radius: 6px;
    color: #2c3e50;
  }
  #checkboxContainer {
    display: flex;
    flex-wrap: wrap;
    gap: 15px 25px;
    margin-top: 10px;
  }
  #checkboxContainer > div {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  #formQuemLimpou button[type="submit"] {
    margin-top: 20px;
  }
  #btnReset {
    margin-top: 10px;
    background-color: #c0392b;
  }
  #btnReset:hover {
    background-color: #e74c3c;
  }
  #avisoReset {
    margin-top: 30px;
    color: #e74c3c;
    font-weight: bold;
  }
  footer {
    margin-top: 20px;
    font-size: 13px;
    color: #7f8c8d;
    text-align: center;
  }
  /* Painel lateral (menu de 3 pontinhos) */
  #btnMenu {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    color: #2c3e50;
  }
  #painelLateral {
    position: fixed;
    top: 0;
    right: -280px;
    width: 280px;
    height: 100vh;
    background: white;
    box-shadow: -2px 0 6px rgb(0 0 0 / 0.15);
    padding: 20px;
    display: flex;
    flex-direction: column;
    transition: right 0.3s ease;
    z-index: 1000;
  }
  #painelLateral.aberto {
    right: 0;
  }
  #painelLateral h3 {
    margin-top: 0;
    margin-bottom: 15px;
    font-weight: bold;
    font-size: 20px;
  }
  #painelLateral label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
  }
  #painelLateral input[type="text"], #painelLateral input[type="email"] {
    width: 100%;
    padding: 8px 10px;
    margin-bottom: 15px;
    border-radius: 5px;
    border: 1px solid #ccc;
    font-size: 14px;
  }
  #painelLateral button {
    background-color: #2c3e50;
    color: white;
    font-weight: bold;
    padding: 10px 15px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s ease;
    margin-top: auto;
  }
  #painelLateral button:hover {
    background-color: #34495e;
  }
  #painelLateral .btnSair {
    background-color: #c0392b;
    margin-top: 10px;
  }
  #painelLateral .btnSair:hover {
    background-color: #e74c3c;
  }
  /* Mensagem de erro de login */
  #msgErroLogin {
    color: red;
    margin-top: 10px;
    font-weight: bold;
  }
</style>
</head>
<body>

<div id="telaInicial">
  <h1>Quem limpa a sala hoje?</h1>
  <button id="btnProfessor">Professor / Representante</button>
  <button id="btnEstudante">Estudante</button>
</div>

<form id="loginForm">
  <h2>Login Professor / Representante</h2>
  <input type="email" id="email" placeholder="Email" required autocomplete="username" />
  <input type="password" id="senha" placeholder="Senha" required autocomplete="current-password" />
  <input type="submit" value="Entrar" />
  <div id="msgErroLogin"></div>
  <button type="button" id="btnVoltarTelaInicial" style="margin-top:10px; background:#7f8c8d;">Voltar</button>
</form>

<!-- Tela professor com edição -->
<div id="app" role="main" aria-label="Painel do professor">
  <button id="btnMenu" aria-label="Abrir menu">⋮</button>
  <button id="btnGerar">Continuar</button>
  <div id="resultado"></div>
  <div id="pergunta" style="display:none;">
    <p>Selecione quem <strong>faltou</strong> ou <strong>limpou o laboratório</strong> e "CONFIRMAR" para atualizar:</p>
    <form id="formQuemLimpou">
      <div id="checkboxContainer"></div>
      <button type="submit">Confirmar</button>
      <div id="avisoReset">
        ⚠️ Cuidado: o botão resetar apaga <u>TODOS</u> os dados!
      </div>
      <button id="btnReset" type="button">Resetar Escala</button>
    </form>
  </div>
</div>

<!-- Tela estudante só para ver -->
<div id="viewEstudante" role="main" aria-label="Visualização para estudante">
  <h2>Escala de hoje</h2>
  <div id="resultadoEstudante"></div>
  <button id="btnSairEstudante">Sair</button>
</div>

<!-- Painel lateral -->
<div id="painelLateral" aria-hidden="true" role="complementary" aria-label="Menu lateral">
  <h3>Configurações</h3>
  <label for="inputNovoAdmin">Adicionar novo administrador (email):</label>
  <input type="email" id="inputNovoAdmin" placeholder="email@exemplo.com" />
  <button id="btnAdicionarAdmin">Adicionar Admin</button>
  <button class="btnSair" id="btnSair">Sair</button>
</div>

<footer>
  <p>© 2025 Nicolas GBM | Criador do projeto.</p>
  <p>Contato: <a href="mailto:nicolasgmbatista15@gmail.com">nicolasgmbatista15@gmail.com</a></p>
</footer>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    updateDoc,
    arrayUnion,
    arrayRemove
  } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

 const firebaseConfig = {
  apiKey: "AIzaSyAGkdnFfJNw4r6yYpSGIpgjwISBOppwR60",
  authDomain: "quem-limpa-hoje.firebaseapp.com",
  projectId: "quem-limpa-hoje",
  storageBucket: "quem-limpa-hoje.firebasestorage.app",
  messagingSenderId: "44929275404",
  appId: "1:44929275404:web:971258e864925cb3684029"
};

  const appFirebase = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getFirestore();

  // Referências a elementos do DOM
  const telaInicial = document.getElementById("telaInicial");
  const btnProfessor = document.getElementById("btnProfessor");
  const btnEstudante = document.getElementById("btnEstudante");
  const loginForm = document.getElementById("loginForm");
  const emailInput = document.getElementById("email");
  const senhaInput = document.getElementById("senha");
  const msgErroLogin = document.getElementById("msgErroLogin");

  const app = document.getElementById("app");
  const btnGerar = document.getElementById("btnGerar");
  const resultado = document.getElementById("resultado");
  const pergunta = document.getElementById("pergunta");
  const formQuemLimpou = document.getElementById("formQuemLimpou");
  const checkboxContainer = document.getElementById("checkboxContainer");
  const btnReset = document.getElementById("btnReset");

  const viewEstudante = document.getElementById("viewEstudante");
  const resultadoEstudante = document.getElementById("resultadoEstudante");
  const btnSairEstudante = document.getElementById("btnSairEstudante");

  const btnMenu = document.getElementById("btnMenu");
  const painelLateral = document.getElementById("painelLateral");
  const inputNovoAdmin = document.getElementById("inputNovoAdmin");
  const btnAdicionarAdmin = document.getElementById("btnAdicionarAdmin");
  const btnSair = document.getElementById("btnSair");
  const btnVoltarTelaInicial = document.getElementById("btnVoltarTelaInicial");

  // Dados fixos dos nomes (pode futuramente salvar no firestore)
  const nomes = [
    "Ana", "Beatriz", "Bernardo", "Emanuelly", "Gabriel", "Gabrielle", "Greicy",
    "Henzo", "Igor", "Isadora", "Jennifer", "Joedna", "Kemilly Silva", "Kemilly Puff",
    "Luiz", "Mateus Yuri", "Mateus Chagas", "Nayara", "Nicolas", "Norehangeles",
    "Pedro", "Samuel", "Sebastião", "Zaira"
  ].sort((a,b) => a.localeCompare(b));

  // Variáveis de controle local
  let posicaoUltimaEscala = JSON.parse(localStorage.getItem('posicaoUltimaEscala'));
  if(typeof posicaoUltimaEscala !== 'number' || isNaN(posicaoUltimaEscala)) posicaoUltimaEscala = -1;
  let historicoTarefa = JSON.parse(localStorage.getItem('historicoTarefa') || '{}');
  let escalaAtual = JSON.parse(localStorage.getItem('escalaAtual') || '[]');
  let faltantesPendentes = JSON.parse(localStorage.getItem('faltantesPendentes') || '[]');

  // Funções para salvar localStorage
  function salvarTudo() {
    localStorage.setItem('posicaoUltimaEscala', JSON.stringify(posicaoUltimaEscala));
    localStorage.setItem('historicoTarefa', JSON.stringify(historicoTarefa));
    localStorage.setItem('escalaAtual', JSON.stringify(escalaAtual));
    localStorage.setItem('faltantesPendentes', JSON.stringify(faltantesPendentes));
  }

  // Alterna tarefa entre mesa e chão
  function alternarTarefa(tarefa) {
    return tarefa === 'mesa' ? 'chão' : 'mesa';
  }

  // Próximo índice para escala, ignorando nomes já usados
  function proximoIndice(atual, nomesIgnorados = []) {
    let i = atual;
    for(let count=0; count<nomes.length; count++) {
      i = (i + 1) % nomes.length;
      if(!nomesIgnorados.includes(nomes[i])) return i;
    }
    return -1;
  }

  // Gera escala inicial ou nova escala
  function gerarEscala() {
    const retornantes = [...faltantesPendentes];
    faltantesPendentes = [];

    let nomesUsados = retornantes.map(f => f.nome);
    let ultimoIdx = posicaoUltimaEscala;

    if(escalaAtual.length === 0) {
      const idx1 = proximoIndice(ultimoIdx, nomesUsados);
      const nome1 = nomes[idx1];
      const tarefa1 = alternarTarefa(historicoTarefa[nome1] || 'mesa');
      historicoTarefa[nome1] = tarefa1;
      nomesUsados.push(nome1);

      const idx2 = proximoIndice(idx1, nomesUsados);
      const nome2 = nomes[idx2];
      const tarefa2 = alternarTarefa(tarefa1);
      historicoTarefa[nome2] = tarefa2;
      nomesUsados.push(nome2);

      escalaAtual = [
        { nome: nome1, tarefa: tarefa1, index: idx1 },
        { nome: nome2, tarefa: tarefa2, index: idx2 }
      ];

      posicaoUltimaEscala = idx2;
      salvarTudo();
      atualizarResultadoEFormulario();
      return;
    }

    // Gera substitutos para faltantes mantendo alternância de tarefas
    const presentes = escalaAtual.filter(p => !retornantes.some(f => f.nome === p.nome));
    const substitutos = [];
    for(let i=0; i<presentes.length; i++) {
      const idx = proximoIndice(ultimoIdx, nomesUsados);
      const nome = nomes[idx];

      const tarefaAnterior = historicoTarefa[nome] || (i === 0 ? 'mesa' : 'chão');
      let novaTarefa;
      if (i === 0) {
        novaTarefa = alternarTarefa(tarefaAnterior);
      } else {
        novaTarefa = substitutos[0].tarefa === 'mesa' ? 'chão' : 'mesa';
      }

      historicoTarefa[nome] = novaTarefa;
      substitutos.push({ nome, tarefa: novaTarefa, index: idx });
      nomesUsados.push(nome);
      ultimoIdx = idx;
    }

    escalaAtual = [...retornantes, ...substitutos].slice(0,2);

    // Ajuste para garantir tarefas diferentes
    if(escalaAtual.length === 2) {
      if(escalaAtual[0].tarefa === escalaAtual[1].tarefa) {
        escalaAtual[1].tarefa = alternarTarefa(escalaAtual[0].tarefa);
        historicoTarefa[escalaAtual[1].nome] = escalaAtual[1].tarefa;
      }
      posicaoUltimaEscala = escalaAtual[1].index;
    }

    salvarTudo();
    atualizarResultadoEFormulario();
  }

  // Confirma faltas e atualiza escala
  function confirmarFaltas() {
    const faltaramHoje = [];
    const presentesHoje = [];
    escalaAtual.forEach(pessoa => {
      const checkbox = document.getElementById(pessoa.nome);
      if(checkbox && checkbox.checked) {
        faltaramHoje.push(pessoa);
      } else {
        presentesHoje.push(pessoa);
      }
    });

    faltantesPendentes = faltantesPendentes.concat(faltaramHoje);

    const novosSubstitutos = [];
    let nomesUsados = escalaAtual.map(p => p.nome).concat(faltantesPendentes.map(f => f.nome));
    let ultimoIdx = posicaoUltimaEscala;

    for(let i=0; i<faltaramHoje.length; i++) {
      let pessoa = faltaramHoje[i];
      let idx = proximoIndice(ultimoIdx, nomesUsados);
      const nome = nomes[idx];
      const tarefaBase = pessoa.tarefa;

      historicoTarefa[pessoa.nome] = tarefaBase;

      novosSubstitutos.push({ nome, tarefa: tarefaBase, index: idx });
      nomesUsados.push(nome);
      ultimoIdx = idx;
    }

    presentesHoje.forEach(p => {
      historicoTarefa[p.nome] = p.tarefa;
    });

    escalaAtual = [...presentesHoje, ...novosSubstitutos].slice(0,2);

    if(escalaAtual.length === 2 && escalaAtual[0].tarefa === escalaAtual[1].tarefa) {
      escalaAtual[1].tarefa = alternarTarefa(escalaAtual[0].tarefa);
      historicoTarefa[escalaAtual[1].nome] = escalaAtual[1].tarefa;
    }

    if(escalaAtual.length === 2) posicaoUltimaEscala = escalaAtual[1].index;

    salvarTudo();
    atualizarResultadoEFormulario();
  }

  // Atualiza a visualização da escala para professores
  function atualizarResultadoEFormulario() {
    if(escalaAtual.length === 0) {
      resultado.innerHTML = '';
      pergunta.style.display = 'none';
      return;
    }

    const listaHtml = escalaAtual.map(p => `<li>${p.nome} ➔ <strong>${p.tarefa}</strong></li>`).join('');
    resultado.innerHTML = `<h2>Escala de hoje:</h2><ul>${listaHtml}</ul>`;

    checkboxContainer.innerHTML = '';
    escalaAtual.forEach(pessoa => {
      const wrapper = document.createElement('div');
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = pessoa.nome;
      checkbox.name = "faltou";
      checkbox.value = pessoa.nome;
      const label = document.createElement('label');
      label.htmlFor = pessoa.nome;
      label.textContent = pessoa.nome;
      wrapper.appendChild(checkbox);
      wrapper.appendChild(label);
      checkboxContainer.appendChild(wrapper);
    });

    pergunta.style.display = 'block';
  }

  // Atualiza visualização para estudantes (somente leitura)
  function atualizarResultadoEstudante() {
    if(escalaAtual.length === 0) {
      resultadoEstudante.innerHTML = '<p>Escala não gerada ainda.</p>';
      return;
    }
    const listaHtml = escalaAtual.map(p => `<li>${p.nome} ➔ <strong>${p.tarefa}</strong></li>`).join('');
    resultadoEstudante.innerHTML = `<ul style="list-style:none; padding:0;">${listaHtml}</ul>`;
  }

  // Controle do painel lateral (menu de 3 pontinhos)
  btnMenu.addEventListener('click', () => {
    if(painelLateral.classList.contains('aberto')) {
      painelLateral.classList.remove('aberto');
      painelLateral.setAttribute('aria-hidden', 'true');
    } else {
      painelLateral.classList.add('aberto');
      painelLateral.setAttribute('aria-hidden', 'false');
    }
  });

  // Adiciona administrador no Firestore
  async function adicionarAdmin() {
    const emailNovo = inputNovoAdmin.value.trim().toLowerCase();
    if(!emailNovo) return alert('Digite um email válido.');

    const docRef = doc(db, "administradores", "listaAdmins");
    const docSnap = await getDoc(docRef);

    if(docSnap.exists()) {
      const data = docSnap.data();
      if(data.emails.includes(emailNovo)) {
        alert('Este email já é administrador.');
        return;
      }
      await updateDoc(docRef, { emails: arrayUnion(emailNovo) });
    } else {
      await setDoc(docRef, { emails: [emailNovo] });
    }

    alert(`Administrador ${emailNovo} adicionado!`);
    inputNovoAdmin.value = '';
  }

  btnAdicionarAdmin.addEventListener('click', adicionarAdmin);

  // Verifica se o usuário atual é admin
  async function verificarAdmin(email) {
    if(!email) return false;
    try {
      const docRef = doc(db, "administradores", "listaAdmins");
      const docSnap = await getDoc(docRef);
      if(docSnap.exists()) {
        const data = docSnap.data();
        return data.emails.includes(email.toLowerCase());
      }
      return false;
    } catch {
      return false;
    }
  }

  // Mostrar telas

  function mostrarTelaInicial() {
    telaInicial.style.display = "flex";
    loginForm.style.display = "none";
    app.style.display = "none";
    viewEstudante.style.display = "none";
    btnMenu.style.display = "none";
    painelLateral.classList.remove('aberto');
    painelLateral.setAttribute('aria-hidden', 'true');
    msgErroLogin.textContent = '';
    // Limpa campos
    emailInput.value = '';
    senhaInput.value = '';
    inputNovoAdmin.value = '';
  }

  function mostrarLogin() {
    telaInicial.style.display = "none";
    loginForm.style.display = "flex";
    app.style.display = "none";
    viewEstudante.style.display = "none";
    btnMenu.style.display = "none";
    painelLateral.classList.remove('aberto');
    painelLateral.setAttribute('aria-hidden', 'true');
    msgErroLogin.textContent = '';
  }

  async function mostrarApp(email) {
    telaInicial.style.display = "none";
    loginForm.style.display = "none";
    viewEstudante.style.display = "none";

    // Verifica admin
    const isAdmin = await verificarAdmin(email);
    if(!isAdmin) {
      alert('Você não tem permissão para acessar esta área.');
      await auth.signOut();
      mostrarTelaInicial();
      return;
    }

    app.style.display = "block";
    btnMenu.style.display = "block";
    atualizarResultadoEFormulario();
  }

  function mostrarEstudante() {
    telaInicial.style.display = "none";
    loginForm.style.display = "none";
    app.style.display = "none";
    viewEstudante.style.display = "block";
    atualizarResultadoEstudante();
  }

  // Eventos da tela inicial
  btnProfessor.addEventListener('click', () => mostrarLogin());
  btnEstudante.addEventListener('click', () => mostrarEstudante());
  btnVoltarTelaInicial.addEventListener('click', () => {
    auth.signOut();
    mostrarTelaInicial();
  });

  // Login professor
  loginForm.addEventListener('submit', e => {
    e.preventDefault();
    const email = emailInput.value.trim();
    const senha = senhaInput.value;

    signInWithEmailAndPassword(auth, email, senha)
      .then(() => {
        msgErroLogin.textContent = '';
      })
      .catch(error => {
        msgErroLogin.textContent = 'Login inválido. Verifique email e senha.';
      });
  });

  // Observa estado de autenticação
  onAuthStateChanged(auth, user => {
    if(user) {
      mostrarApp(user.email);
    } else {
      // Se não está logado, mostra tela inicial
      mostrarTelaInicial();
    }
  });

  // Botões do app professor
  btnGerar.addEventListener('click', gerarEscala);

  formQuemLimpou.addEventListener('submit', e => {
    e.preventDefault();
    confirmarFaltas();
  });

  btnReset.addEventListener('click', () => {
    if(confirm("Tem certeza que quer resetar a escala? Todos os dados serão apagados.")) {
      localStorage.clear();
      posicaoUltimaEscala = -1;
      historicoTarefa = {};
      escalaAtual = [];
      faltantesPendentes = [];
      salvarTudo();
      atualizarResultadoEFormulario();
    }
  });

  btnSair.addEventListener('click', async () => {
    await auth.signOut();
    mostrarTelaInicial();
  });

  btnSairEstudante.addEventListener('click', () => {
    mostrarTelaInicial();
  });

  // Ao carregar a página, tenta mostrar escala se estiver logado
  window.onload = () => {
    // Nada a fazer aqui, onAuthStateChanged já controla a tela
  };
</script>

</body>
</html>
