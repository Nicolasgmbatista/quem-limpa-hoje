
  if (jaLimpouHoje.length >= nomes.length - 1) {
    jaLimpouHoje = [];
    historicoTarefa = {};
    posicaoUltimaEscala = -1;
  }

  const nomesIgnorados = escalaAtual.map(p => p.nome);
  const index1 = proximoIndice(posicaoUltimaEscala, nomesIgnorados);
  const nome1 = nomes[index1];

  const index2 = proximoIndice(index1, [...nomesIgnorados, nome1]);

  if (index2 === -1) {
    jaLimpouHoje = [];
    historicoTarefa = {};
    posicaoUltimaEscala = -1;
    gerarEscala();
    return;
  }

  const nome2 = nomes[index2];

  const tarefa1Anterior = historicoTarefa[nome1] || 'mesa';
  const tarefa1 = alternarTarefa(tarefa1Anterior);
  const tarefa2 = tarefa1 === 'mesa' ? 'chão' : 'mesa';

  historicoTarefa[nome1] = tarefa1;
  historicoTarefa[nome2] = tarefa2;

  escalaAtual = [
    { nome: nome1, tarefa: tarefa1, index: index1 },
    { nome: nome2, tarefa: tarefa2, index: index2 }
  ];

  posicaoUltimaEscala = index2;
  salvarTudo();
  atualizarResultadoEFormulario();
}

function atualizarResultadoEFormulario() {
  const listaHtml = escalaAtual.map(t => `<li>${t.nome} — limpar <strong>${t.tarefa}</strong></li>`).join('');
  document.getElementById('resultado').innerHTML = `<h2>Escala de hoje:</h2><ul>${listaHtml}</ul>`;

  const container = document.getElementById('checkboxContainer');
  container.innerHTML = '';
  escalaAtual.forEach(pessoa => {
    const wrapper = document.createElement('div');
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = pessoa.nome;
    checkbox.name = "limpou";
    checkbox.value = pessoa.nome;
    const label = document.createElement('label');
    label.htmlFor = pessoa.nome;
    label.textContent = pessoa.nome;
    wrapper.appendChild(checkbox);
    wrapper.appendChild(label);
    container.appendChild(wrapper);
  });

  document.getElementById('pergunta').style.display = 'block';
}

window.onload = function() {
  if (escalaAtual.length === 2) {
    atualizarResultadoEFormulario();
  }
};

document.getElementById('btnGerar').onclick = gerarEscala;

document.getElementById('formQuemLimpou').onsubmit = function(e) {
  e.preventDefault();

  const naoMarcados = escalaAtual.filter(p => !document.getElementById(p.nome).checked).map(p => p.nome);
  let nomesUsados = [...naoMarcados];

  escalaAtual = escalaAtual.map(pessoa => {
    const marcou = document.getElementById(pessoa.nome).checked;

    if (marcou) {
      if (!jaLimpouHoje.includes(pessoa.nome)) {
        jaLimpouHoje.push(pessoa.nome);
      }

      const novoIndex = proximoIndice(pessoa.index, nomesUsados);
      const novoNome = nomes[novoIndex];
      nomesUsados.push(novoNome);

      const tarefaAntiga = pessoa.tarefa;
      historicoTarefa[novoNome] = tarefaAntiga;

      return { nome: novoNome, tarefa: tarefaAntiga, index: novoIndex };
    } else {
      return pessoa;
    }
  });

  salvarTudo();
  atualizarResultadoEFormulario();
};
</script>

</body>
</html>
