<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quem limpa a sala hoje?</title>
<style>
  /* --- RESET BÁSICO --- */
  * {
    margin: 0; padding: 0; box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #1e2a38;
    color: #dce6f0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1 {
    margin-top: 40px;
    font-size: 2.8rem;
    font-weight: 800;
    color: #54a0ff;
  }
  /* Tela inicial seleção */
  #tipoUsuarioSelection {
    margin-top: 40px;
    display: flex;
    gap: 50px;
  }
  #tipoUsuarioSelection button {
    background: #54a0ff;
    border: none;
    color: #1e2a38;
    padding: 18px 48px;
    font-weight: 900;
    font-size: 1.5rem;
    border-radius: 18px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  #tipoUsuarioSelection button:hover {
    background: #3b7dd8;
  }

  /* CONTAINER LOGIN */
  #loginContainer {
    margin-top: 40px;
    background-color: #273549;
    border-radius: 18px;
    padding: 30px 40px;
    width: 360px;
    display: none;
    flex-direction: column;
    gap: 18px;
    box-shadow: 0 0 14px rgba(84, 160, 255, 0.5);
  }
  #loginContainer input {
    background-color: #36475a;
    border: none;
    border-radius: 14px;
    padding: 14px 20px;
    font-size: 1.15rem;
    color: #dce6f0;
    outline-offset: 2px;
    outline-color: #54a0ff;
    transition: outline-color 0.3s ease;
  }
  #loginContainer input::placeholder {
    color: #a0b0c0;
  }
  #loginContainer input:focus {
    outline-color: #89c1ff;
  }
  #btnLogin {
    background-color: #54a0ff;
    border: none;
    border-radius: 18px;
    padding: 16px;
    font-weight: 900;
    font-size: 1.25rem;
    color: #1e2a38;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  #btnLogin:hover {
    background-color: #3b7dd8;
  }
  #loginErro {
    color: #ff6b6b;
    font-weight: 700;
    font-size: 1rem;
    display: none;
    text-align: center;
  }

  /* CONTAINER ESCALA */
  #escalaContainer {
    margin-top: 40px;
    background-color: #273549;
    border-radius: 18px;
    padding: 25px 30px;
    width: 420px;
    max-width: 95vw;
    box-shadow: 0 0 18px rgba(84, 160, 255, 0.6);
    display: none;
    flex-direction: column;
    align-items: center;
    position: relative;
  }
  #escalaContainer h2 {
    color: #54a0ff;
    font-weight: 900;
    font-size: 2rem;
    margin-bottom: 20px;
  }
  #escalaLista {
    width: 100%;
    list-style: none;
    margin-bottom: 20px;
  }
  #escalaLista li {
    background-color: #36475a;
    padding: 16px 22px;
    margin-bottom: 14px;
    border-radius: 14px;
    font-weight: 700;
    font-size: 1.3rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
  }
  #btnGerar {
    background-color: #54a0ff;
    color: #1e2a38;
    padding: 16px 42px;
    border-radius: 18px;
    font-weight: 900;
    font-size: 1.3rem;
    border: none;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
    margin-bottom: 15px;
  }
  #btnGerar:hover {
    background-color: #3b7dd8;
  }

  /* FORM PARA CONFIRMAR FALTAS E QUEM LIMPOU */
  #pergunta {
    width: 100%;
    margin-top: 10px;
    display: none;
    flex-direction: column;
    gap: 15px;
    text-align: center;
    font-weight: 700;
    color: #a0b0c0;
  }
  #checkboxContainer {
    display: flex;
    flex-wrap: wrap;
    gap: 16px 28px;
    justify-content: center;
  }
  #checkboxContainer div {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  #checkboxContainer label {
    cursor: pointer;
    user-select: none;
    font-weight: 700;
    font-size: 1.1rem;
    color: #dce6f0;
  }
  #formQuemLimpou button[type="submit"] {
    margin-top: 22px;
    background-color: #54a0ff;
    color: #1e2a38;
    border: none;
    padding: 16px 30px;
    font-weight: 900;
    border-radius: 18px;
    cursor: pointer;
    font-size: 1.3rem;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  #formQuemLimpou button[type="submit"]:hover {
    background-color: #3b7dd8;
  }

  /* AVISO RESET */
  #avisoReset {
    margin-top: 25px;
    color: #ff6b6b;
    font-weight: 800;
    font-size: 1rem;
    text-align: center;
    user-select: none;
  }

  /* PAINEL LATERAL 3 PONTINHOS */
  #menuLateral {
    position: fixed;
    top: 60px;
    right: 25px;
    background-color: #273549;
    border-radius: 18px;
    box-shadow: 0 8px 22px rgba(84, 160, 255, 0.5);
    padding: 12px;
    display: none;
    flex-direction: column;
    gap: 16px;
    user-select: none;
    z-index: 2000;
    min-width: 180px;
  }
  #menuLateral button {
    background: none;
    border: none;
    padding: 12px 20px;
    font-weight: 900;
    font-size: 1.15rem;
    color: #54a0ff;
    border-radius: 12px;
    cursor: pointer;
    text-align: left;
    transition: background-color 0.25s ease;
  }
  #menuLateral button:hover {
    background-color: #3b7dd8;
    color: #dce6f0;
  }

  /* BOTÃO 3 PONTINHOS TOPO DIREITO */
  #btnMenuToggle {
    position: fixed;
    top: 15px;
    right: 20px;
    background-color: #54a0ff;
    border-radius: 50%;
    width: 46px;
    height: 46px;
    border: none;
    color: #1e2a38;
    font-size: 32px;
    line-height: 0;
    cursor: pointer;
    user-select: none;
    display: none; /* Só admins veem */
    z-index: 2100;
    box-shadow: 0 2px 10px rgba(84, 160, 255, 0.5);
  }

  /* RODAPÉ */
  footer {
    margin-top: auto;
    padding: 20px 0 40px 0;
    font-size: 15px;
    color: #7f8c8d;
    user-select: none;
    text-align: center;
    width: 100%;
  }
  footer a {
    color: #54a0ff;
    text-decoration: none;
  }
  footer a:hover {
    text-decoration: underline;
  }

  /* OCULTAR PARA ALUNOS */
  body.tipo-aluno #btnGerar,
  body.tipo-aluno #btnMenuToggle,
  body.tipo-aluno #menuLateral {
    display: none !important;
  }
</style>
</head>
<body>

  <h1>Quem limpa a sala hoje?</h1>

  <!-- Tela inicial para escolher usuário -->
  <div id="tipoUsuarioSelection">
    <button id="btnAluno">Estudante</button>
    <button id="btnAdmin">Professor / Representante</button>
  </div>

  <!-- Login Admin -->
  <div id="loginContainer" aria-label="Formulário de login">
    <input type="email" id="emailInput" placeholder="E-mail" autocomplete="username" aria-label="E-mail" />
    <input type="password" id="senhaInput" placeholder="Senha" autocomplete="current-password" aria-label="Senha" />
    <button id="btnLogin" aria-label="Entrar no sistema">Entrar</button>
    <div id="loginErro" role="alert" aria-live="assertive">Login inválido. Tente novamente.</div>
  </div>

  <!-- Container da escala -->
  <div id="escalaContainer" aria-live="polite" aria-atomic="true" aria-relevant="additions removals">
    <h2>Escala de hoje:</h2>
    <ul id="escalaLista" aria-label="Lista da escala"></ul>
    <button id="btnGerar" aria-label="Gerar ou continuar escala">Continuar</button>

    <div id="pergunta" aria-label="Confirmação de faltas e limpeza">
      <p>Selecione quem <strong>faltou</strong> ou <strong>limpou o laboratório</strong> e "CONFIRMAR" para atualizar:</p>
      <form id="formQuemLimpou" aria-label="Formulário para confirmar faltas e limpezas">
        <div id="checkboxContainer"></div>
        <button type="submit" aria-label="Confirmar faltas e limpezas">Confirmar</button>
      </form>
      <div id="avisoReset">
        ⚠️ Cuidado: o botão resetar apaga <u>TODOS</u> os dados!
      </div>
    </div>
  </div>

  <!-- Botão menu lateral (3 pontinhos) -->
  <button id="btnMenuToggle" title="Menu" aria-haspopup="true" aria-expanded="false">⋮</button>

  <!-- Menu lateral -->
  <div id="menuLateral" role="menu" aria-label="Menu lateral">
    <button id="btnLiberarAcesso" role="menuitem">Liberar acesso</button>
    <button id="btnReset" role="menuitem">Resetar escala</button>
    <button id="btnSair" role="menuitem">Sair</button>
  </div>

  <footer>
    <p>© 2025 Nicolas GBM | Criador do projeto.</p>
    <p>Contato: <a href="mailto:nicolasgmbatista15@gmail.com">nicolasgmbatista15@gmail.com</a></p>
  </footer>

  <script>
    /* ===============================
     *  CONFIGURAÇÕES INICIAIS E ESTADO
     * =============================== */

    // Lista fixa de nomes (ordenada)
    const nomes = [
      "Ana", "Beatriz", "Bernardo", "Emanuelly", "Gabriel", "Gabrielle", "Greicy",
      "Henzo", "Igor", "Isadora", "Jennifer", "Joedna", "Kemilly Silva", "Kemilly Puff",
      "Luiz", "Mateus Yuri", "Mateus Chagas", "Nayara", "Nicolas", "Norehangeles",
      "Pedro", "Samuel", "Sebastião", "Zaira"
    ].sort((a,b) => a.localeCompare(b));

    // Estado salvo no localStorage
    let posicaoUltimaEscala = JSON.parse(localStorage.getItem('posicaoUltimaEscala'));
    if(typeof posicaoUltimaEscala !== 'number' || isNaN(posicaoUltimaEscala)) posicaoUltimaEscala = -1;

    let historicoTarefa = JSON.parse(localStorage.getItem('historicoTarefa') || '{}');
    let escalaAtual = JSON.parse(localStorage.getItem('escalaAtual') || '[]');
    let faltantesPendentes = JSON.parse(localStorage.getItem('faltantesPendentes') || '[]');

    // Tipo de usuário atual ('admin', 'aluno' ou null)
    let tipoUsuario = null;

    // Referências DOM
    const tipoUsuarioSelection = document.getElementById('tipoUsuarioSelection');
    const loginContainer = document.getElementById('loginContainer');
    const emailInput = document.getElementById('emailInput');
    const senhaInput = document.getElementById('senhaInput');
    const btnLogin = document.getElementById('btnLogin');
    const loginErro = document.getElementById('loginErro');
    const escalaContainer = document.getElementById('escalaContainer');
    const escalaLista = document.getElementById('escalaLista');
    const btnGerar = document.getElementById('btnGerar');
    const pergunta = document.getElementById('pergunta');
    const checkboxContainer = document.getElementById('checkboxContainer');
    const formQuemLimpou = document.getElementById('formQuemLimpou');
    const avisoReset = document.getElementById('avisoReset');
    const btnMenuToggle = document.getElementById('btnMenuToggle');
    const menuLateral = document.getElementById('menuLateral');
    const btnLiberarAcesso = document.getElementById('btnLiberarAcesso');
    const btnReset = document.getElementById('btnReset');
    const btnSair = document.getElementById('btnSair');

    /* ===============================
     *  FUNÇÕES AUXILIARES DE ESTADO
     * =============================== */

    // Salva todo estado no localStorage
    function salvarTudo() {
      localStorage.setItem('posicaoUltimaEscala', JSON.stringify(posicaoUltimaEscala));
      localStorage.setItem('historicoTarefa', JSON.stringify(historicoTarefa));
      localStorage.setItem('escalaAtual', JSON.stringify(escalaAtual));
      localStorage.setItem('faltantesPendentes', JSON.stringify(faltantesPendentes));
    }

    // Alterna tarefa entre 'mesa' e 'chão'
    function alternarTarefa(tarefa) {
      return tarefa === 'mesa' ? 'chão' : 'mesa';
    }

    // Retorna próximo índice no array nomes ignorando os nomes de nomesIgnorados
    function proximoIndice(atual, nomesIgnorados = []) {
      let i = atual;
      for(let count=0; count<nomes.length; count++) {
        i = (i + 1) % nomes.length;
        if(!nomesIgnorados.includes(nomes[i])) return i;
      }
      return -1; // não encontrou (extremo improvável)
    }

    /* ===============================
     *  LÓGICA DE ESCALA
     * =============================== */

    // Gera a escala considerando faltantes, alternância, etc
    function gerarEscala() {
      // Pega quem faltou da última vez para reaproveitar
      const retornantes = [...faltantesPendentes];
      faltantesPendentes = [];

      let nomesUsados = retornantes.map(f => f.nome);
      let ultimoIdx = posicaoUltimaEscala;

      // Se escalaAtual vazia, gerar a primeira escala
      if(escalaAtual.length === 0) {
        // Primeiro aluno
        const idx1 = proximoIndice(ultimoIdx, nomesUsados);
        const nome1 = nomes[idx1];
        const tarefa1 = alternarTarefa(historicoTarefa[nome1] || 'mesa');
        historicoTarefa[nome1] = tarefa1;
        nomesUsados.push(nome1);

        // Segundo aluno
        const idx2 = proximoIndice(idx1, nomesUsados);
        const nome2 = nomes[idx2];
        const tarefa2 = alternarTarefa(tarefa1);
        historicoTarefa[nome2] = tarefa2;
        nomesUsados.push(nome2);

        escalaAtual = [
          { nome: nome1, tarefa: tarefa1, index: idx1 },
          { nome: nome2, tarefa: tarefa2, index: idx2 }
        ];

        posicaoUltimaEscala = idx2;
        salvarTudo();
        atualizarResultadoEFormulario();
        return;
      }

      // Se tem faltantes pendentes, substitui eles pelos próximos
      const presentes = escalaAtual.filter(p => !retornantes.some(f => f.nome === p.nome));
      const substitutos = [];

      for(let i=0; i<presentes.length; i++) {
        const idx = proximoIndice(ultimoIdx, nomesUsados);
        const nome = nomes[idx];
        const tarefaAnterior = historicoTarefa[nome] || (i === 0 ? 'mesa' : 'chão');
        let novaTarefa;
        if (i === 0) {
          novaTarefa = alternarTarefa(tarefaAnterior);
        } else {
          novaTarefa = alternarTarefa(presentes[0].tarefa);
        }
        historicoTarefa[nome] = novaTarefa;
        nomesUsados.push(nome);
        substitutos.push({nome, tarefa: novaTarefa, index: idx});
        ultimoIdx = idx;
      }

      escalaAtual = substitutos;
      posicaoUltimaEscala = ultimoIdx;
      salvarTudo();
      atualizarResultadoEFormulario();
    }

    // Atualiza lista da escala e checkbox para confirmação
    function atualizarResultadoEFormulario() {
      escalaLista.innerHTML = '';
      checkboxContainer.innerHTML = '';

      escalaAtual.forEach((pessoa, i) => {
        // Item escala
        const li = document.createElement('li');
        li.textContent = `${pessoa.nome} — ${pessoa.tarefa.toUpperCase()}`;
        escalaLista.appendChild(li);

        // Checkbox para confirmar (faltou ou limpou)
        const divCheckbox = document.createElement('div');
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.id = `check_${i}`;
        chk.name = 'faltouOuLimpou';
        chk.value = pessoa.nome;
        const label = document.createElement('label');
        label.htmlFor = chk.id;
        label.textContent = pessoa.nome;

        divCheckbox.appendChild(chk);
        divCheckbox.appendChild(label);
        checkboxContainer.appendChild(divCheckbox);
      });

      // Exibe o form de confirmação para admins, esconde para alunos
      if(tipoUsuario === 'admin') {
        pergunta.style.display = 'flex';
      } else {
        pergunta.style.display = 'none';
      }
    }

    // Confirma quem limpou ou faltou, atualiza escala substituindo
    function confirmarFaltasLimpou(event) {
      event.preventDefault();

      const checkboxes = [...document.querySelectorAll('input[name="faltouOuLimpou"]:checked')];
      if(checkboxes.length === 0) {
        alert("Selecione pelo menos uma pessoa que faltou ou limpou.");
        return;
      }

      const selecionados = checkboxes.map(c => c.value);
      // Atualiza faltantes pendentes para próxima geração
      faltantesPendentes = selecionados.map(nome => ({ nome }));

      // Substitui na escala atual
      selecionados.forEach(nomeFaltou => {
        const idxNaEscala = escalaAtual.findIndex(e => e.nome === nomeFaltou);
        if(idxNaEscala >= 0) {
          // Remove do array nomes para não repetir
          const nomesIgnorados = escalaAtual.map(e => e.nome).filter(n => n !== nomeFaltou);
          // Pega próximo nome fora da escala atual e ignorados
          const proxIdx = proximoIndice(posicaoUltimaEscala, nomesIgnorados.concat(faltantesPendentes.map(f=>f.nome)));
          const novoNome = nomes[proxIdx];

          const novaTarefa = alternarTarefa(historicoTarefa[novoNome] || escalaAtual[idxNaEscala].tarefa);
          historicoTarefa[novoNome] = novaTarefa;

          escalaAtual[idxNaEscala] = { nome: novoNome, tarefa: novaTarefa, index: proxIdx };
          posicaoUltimaEscala = proxIdx;
        }
      });

      salvarTudo();
      atualizarResultadoEFormulario();

      // Limpa seleção checkboxes após confirmar
      formQuemLimpou.reset();
    }

    /* ===============================
     *  LOGIN SIMPLIFICADO (FAKE FIREBASE)
     * =============================== */

    // Lista fixa de admins (email e senha)
    const admins = [
      {email: 'professor@escola.com', senha: '123456'},
      {email: 'admin@lab.com', senha: 'senha123'}
    ];

    // Simula login Firebase Authentication
    function loginFirebase(email, senha) {
      return new Promise((resolve, reject) => {
        const adm = admins.find(a => a.email === email && a.senha === senha);
        if(adm) {
          setTimeout(() => resolve({email: adm.email}), 700);
        } else {
          setTimeout(() => reject(new Error('Usuário ou senha inválidos')), 700);
        }
      });
    }

    /* ===============================
     *  INTERAÇÕES E EVENTOS
     * =============================== */

    // Ao escolher aluno, vai direto para escala sem login
    document.getElementById('btnAluno').addEventListener('click', () => {
      tipoUsuario = 'aluno';
      document.body.classList.add('tipo-aluno');
      tipoUsuarioSelection.style.display = 'none';
      escalaContainer.style.display = 'flex';
      loginContainer.style.display = 'none';
      btnMenuToggle.style.display = 'none';
      atualizarResultadoEFormulario();
    });

    // Ao escolher admin, mostra login
    document.getElementById('btnAdmin').addEventListener('click', () => {
      tipoUsuario = null;
      tipoUsuarioSelection.style.display = 'none';
      loginContainer.style.display = 'flex';
      escalaContainer.style.display = 'none';
      btnMenuToggle.style.display = 'none';
      loginErro.style.display = 'none';
      emailInput.value = '';
      senhaInput.value = '';
      emailInput.focus();
    });

    // Ao clicar em login
    btnLogin.addEventListener('click', () => {
      const email = emailInput.value.trim().toLowerCase();
      const senha = senhaInput.value;

      loginFirebase(email, senha)
        .then(user => {
          tipoUsuario = 'admin';
          document.body.classList.remove('tipo-aluno');
          loginContainer.style.display = 'none';
          escalaContainer.style.display = 'flex';
          btnMenuToggle.style.display = 'block';
          loginErro.style.display = 'none';

          atualizarResultadoEFormulario();
        })
        .catch(() => {
          loginErro.style.display = 'block';
        });
    });

    // Gerar ou continuar escala
    btnGerar.addEventListener('click', () => {
      gerarEscala();
    });

    // Confirmar faltas e limpezas
    formQuemLimpou.addEventListener('submit', confirmarFaltasLimpou);

    // Botão do menu lateral (3 pontinhos)
    btnMenuToggle.addEventListener('click', () => {
      if(menuLateral.style.display === 'flex') {
        menuLateral.style.display = 'none';
        btnMenuToggle.setAttribute('aria-expanded', 'false');
      } else {
        menuLateral.style.display = 'flex';
        btnMenuToggle.setAttribute('aria-expanded', 'true');
      }
    });

    // Resetar escala - apaga tudo do localStorage
    btnReset.addEventListener('click', () => {
      if(confirm('Tem certeza que deseja RESETAR toda a escala? Isso apagará todos os dados.')) {
        posicaoUltimaEscala = -1;
        historicoTarefa = {};
        escalaAtual = [];
        faltantesPendentes = [];
        salvarTudo();
        atualizarResultadoEFormulario();
        menuLateral.style.display = 'none';
      }
    });

    // Logout - sai para tela inicial
    btnSair.addEventListener('click', () => {
      tipoUsuario = null;
      document.body.classList.remove('tipo-aluno');
      escalaContainer.style.display = 'none';
      loginContainer.style.display = 'none';
      tipoUsuarioSelection.style.display = 'flex';
      btnMenuToggle.style.display = 'none';
      menuLateral.style.display = 'none';
      emailInput.value = '';
      senhaInput.value = '';
      loginErro.style.display = 'none';
    });

    // Liberar acesso (futuro, só alert por enquanto)
    btnLiberarAcesso.addEventListener('click', () => {
      alert('Funcionalidade "Liberar acesso" será implementada futuramente.');
    });

    // Na inicialização, se tiver escala salva, carrega ela
    window.addEventListener('load', () => {
      if(escalaAtual.length > 0) {
        // Exibe tela de login ou seleção dependendo do tipo salvo
        tipoUsuarioSelection.style.display = 'flex';
      }
    });
  </script>

</body>
</html>
