document.getElementById('formQuemLimpou').onsubmit = function(e) {
  e.preventDefault();

  // Lista para nomes novos na escala, já excluindo repetidos
  let novosNomes = [];

  escalaAtual = escalaAtual.map(pessoa => {
    const marcou = document.getElementById(pessoa.nome).checked;

    if (marcou) {
      // Pessoa limpou hoje, adicionar na lista de quem já limpou
      if (!jaLimpouHoje.includes(pessoa.nome)) {
        jaLimpouHoje.push(pessoa.nome);
      }
      // Buscar próximo índice disponível que não está em jaLimpouHoje nem nos nomes da escala
      let novoIndex = pessoa.index;
      let tentativas = 0;
      do {
        novoIndex = (novoIndex + 1) % nomes.length;
        tentativas++;
        // Evitar loop infinito
        if (tentativas > nomes.length) {
          // Se não achar ninguém, fica com o mesmo nome (mas isso não deveria ocorrer)
          break;
        }
      } while (jaLimpouHoje.includes(nomes[novoIndex]) || novosNomes.includes(nomes[novoIndex]));

      const novoNome = nomes[novoIndex];
      novosNomes.push(novoNome);

      // Alterna a tarefa: se último foi mesa, agora chão e vice-versa
      const novaTarefa = (historicoTarefa[novoNome] === 'mesa') ? 'chão' : 'mesa';

      // Atualiza histórico para esse novo nome
      historicoTarefa[novoNome] = novaTarefa;

      // Retorna o novo objeto com nome e tarefa atualizados
      return { nome: novoNome, tarefa: novaTarefa, index: novoIndex };

    } else {
      // Pessoa não limpou hoje, mantém na escala, atualiza histórico tarefa (inverte)
      const novaTarefa = (pessoa.tarefa === 'mesa') ? 'chão' : 'mesa';
      historicoTarefa[pessoa.nome] = novaTarefa;

      // Também adiciona ao novosNomes para evitar repetição se o outro trocar
      novosNomes.push(pessoa.nome);

      return { nome: pessoa.nome, tarefa: novaTarefa, index: pessoa.index };
    }
  });

  // Atualiza a posição da última escala com o índice da última pessoa da escala atual
  posicaoUltimaEscala = escalaAtual[escalaAtual.length - 1].index;

  salvarTudo();

  // Atualiza a lista na tela
  const listaHtml = escalaAtual.map(t => `<li>${t.nome} — limpar <strong>${t.tarefa}</strong></li>`).join('');
  document.getElementById('resultado').innerHTML = `<h2>Escala de hoje:</h2><ul>${listaHtml}</ul>`;

  document.getElementById('pergunta').style.display = 'none';
};
